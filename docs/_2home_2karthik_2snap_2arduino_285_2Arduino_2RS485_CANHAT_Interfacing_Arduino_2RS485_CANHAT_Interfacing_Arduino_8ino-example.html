<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RS485 CANHAT Interfacing with Arduino - ARTPART Assessment: /home/karthik/snap/arduino/85/Arduino/RS485_CANHAT_Interfacing_Arduino/RS485_CANHAT_Interfacing_Arduino.ino</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">RS485 CANHAT Interfacing with Arduino - ARTPART Assessment<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">Solution for Interfacing RS485 CANHAT with Arduino using a hardware bridge transceiver approach. As part of ARTPARK Assesment.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">/home/karthik/snap/arduino/85/Arduino/RS485_CANHAT_Interfacing_Arduino/RS485_CANHAT_Interfacing_Arduino.ino</div></div>
</div><!--header-->
<div class="contents">
<p>Expected CAN message data format for battery charge monitoring.</p>
<p>Expected CAN message data format for battery charge monitoring.- <b>CAN ID</b>: <code>0x100</code> (as example desired Battery charge sender device ID).</p><ul>
<li><b>Data Length</b>: 2 bytes.</li>
<li><b>Data Payload</b>:<ul>
<li><b>Byte 0</b>: Lower byte of battery charge value.</li>
<li><b>Byte 1</b>: Higher byte of battery charge value.</li>
</ul>
</li>
</ul>
<p>2-byte data payload will be combined into a single 16-bit integer representing the battery charge. This value will then be scaled by <code>BATTERY_SCALE</code> to convert it into a percentage. EXAMPLE output of expected data format is provided below, with some raw values assumed for the sake of example demo.</p>
<p>// - CAN_BUS GET DATA - // CAN ID: 0x100 // Data Length: 2 // Data: [0xC8, 0x00] // Battery Charge: 2.00 %</p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mcp__can_8h.html">mcp_can.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;SPI.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><a id="_a0" name="_a0"></a><a class="code hl_class" href="classMCP__CAN.html">MCP_CAN</a> <a id="a1" name="a1"></a><a class="code hl_variable" href="mcp__can_8cpp.html#ae0f879ad16313dd3d0ae6074a887918f">CAN</a>(10); </div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a id="a2" name="a2"></a><a class="code hl_variable" href="RS485__CANHAT__Interfacing__Arduino_8ino.html#a09f97bd739f2e6ad7f715691adbf8dc1">BATTERY_CHARGE_CAN_ID</a> = 0x100; </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">float</span> <a id="a3" name="a3"></a><a class="code hl_variable" href="RS485__CANHAT__Interfacing__Arduino_8ino.html#abd34c2c9f838ac6dfba8d2f600f87e7f">BATTERY_SCALE</a> = 100.0; </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Variables</span></div>
<div class="line"><span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a id="a4" name="a4"></a><a class="code hl_variable" href="receive_8ino.html#a25a5e2b8e715ec6077463e9effdcbd48">Flag_Recv</a> = 0; </div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a id="a5" name="a5"></a><a class="code hl_variable" href="receive_8ino.html#a8bb3e1dd5fd30402c69fd8a9f7dd0950">len</a> = 0; </div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a id="a6" name="a6"></a><a class="code hl_variable" href="receive_8ino.html#af5995a340a85e31e0916dd382c9b8eda">buf</a>[8]; </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a id="a7" name="a7"></a><a class="code hl_function" href="receive_8ino.html#ae4617499c61ae6c8bf1e9433b5436b8d">MCP2515_ISR</a>()</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_variable" href="receive_8ino.html#a25a5e2b8e715ec6077463e9effdcbd48">Flag_Recv</a> = 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a id="a8" name="a8"></a><a class="code hl_function" href="receive_8ino.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a>()</div>
<div class="line">{</div>
<div class="line">    Serial.begin(115200); </div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*Initialize the CAN-BUS Shield</span></div>
<div class="line"><span class="comment">    * Why 500 kbps when module supports upto 1Mbps? Just avoids signal integrity issues in PCB.</span></div>
<div class="line"><span class="comment">    * It also allows us to use longer length (approx 100 meteres)</span></div>
<div class="line"><span class="comment">    * I wouldn&#39;t want to overload the CAN Transceiver, I think 500Kbps suits well for our application (access battery charge)</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keywordflow">while</span> (<a id="a9" name="a9"></a><a class="code hl_define" href="mcp__can__dfs_8h.html#a828ca6464d281c8b2a780169ac2c6318">CAN_OK</a> != <a class="code hl_variable" href="mcp__can_8cpp.html#ae0f879ad16313dd3d0ae6074a887918f">CAN</a>.<a id="a10" name="a10"></a><a class="code hl_function" href="classMCP__CAN.html#a744792a91a4604e22132f787dd2114b0">begin</a>(<a id="a11" name="a11"></a><a class="code hl_define" href="mcp__can__dfs_8h.html#a838186bc9587b888bf99f730e69fc70d">CAN_500KBPS</a>))</div>
<div class="line">    {</div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;CAN BUS Shield initialization failed. Retrying...&quot;</span>);</div>
<div class="line">        delay(100); <span class="comment">// Power on software delay + Initialisation delay + Retry delay</span></div>
<div class="line">    }</div>
<div class="line">    Serial.println(<span class="stringliteral">&quot;CAN BUS Shield initialized successfully.&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Attach interrupt that triggers during clock falling edge. This is to handle CAN message reception</span></div>
<div class="line"><span class="comment">     *  Interrupt Pin = 0 is the Arduino Pin 2. So we connect the INT pin of the module to Pin 2 of our Arduino</span></div>
<div class="line"><span class="comment">     *  This executes `MCP2515_ISR` function to set receive interrupt flag initially. </span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    attachInterrupt(0, <a class="code hl_function" href="receive_8ino.html#ae4617499c61ae6c8bf1e9433b5436b8d">MCP2515_ISR</a>, FALLING);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a id="a12" name="a12"></a><a class="code hl_function" href="receive_8ino.html#afe461d27b9c48d5921c00d521181f12f">loop</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Check if a CAN message was received</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_variable" href="receive_8ino.html#a25a5e2b8e715ec6077463e9effdcbd48">Flag_Recv</a>)</div>
<div class="line">    {</div>
<div class="line">        <a class="code hl_variable" href="receive_8ino.html#a25a5e2b8e715ec6077463e9effdcbd48">Flag_Recv</a> = 0; </div>
<div class="line">        <span class="comment">/* </span></div>
<div class="line"><span class="comment">        *  To read received CAN messsage</span></div>
<div class="line"><span class="comment">        *  Iterates over the payload `m_nDta` (array with CAN message dat bytes) for copying valid bytes into the buffer array `buf` I provided.</span></div>
<div class="line"><span class="comment">        */</span></div>
<div class="line">        <a class="code hl_variable" href="mcp__can_8cpp.html#ae0f879ad16313dd3d0ae6074a887918f">CAN</a>.<a id="a13" name="a13"></a><a class="code hl_function" href="classMCP__CAN.html#a4a09b0c8d110b0e5a3900fadc7137632">readMsgBuf</a>(&amp;<a class="code hl_variable" href="receive_8ino.html#a8bb3e1dd5fd30402c69fd8a9f7dd0950">len</a>, <a class="code hl_variable" href="receive_8ino.html#af5995a340a85e31e0916dd382c9b8eda">buf</a>);</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> canId = <a class="code hl_variable" href="mcp__can_8cpp.html#ae0f879ad16313dd3d0ae6074a887918f">CAN</a>.<a id="a14" name="a14"></a><a class="code hl_function" href="classMCP__CAN.html#a17db0c4bf45f6e0354c22ebb7ab218d6">getCanId</a>();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Logs CAN ID and length of data received of &quot;any&quot; sender that has sent data </span></div>
<div class="line">        Serial.println(<span class="stringliteral">&quot;- CAN_BUS GET DATA -&quot;</span>);</div>
<div class="line">        Serial.print(<span class="stringliteral">&quot;CAN ID: &quot;</span>); Serial.println(canId, HEX); </div>
<div class="line">        Serial.print(<span class="stringliteral">&quot;Data Length: &quot;</span>); Serial.println(<a class="code hl_variable" href="receive_8ino.html#a8bb3e1dd5fd30402c69fd8a9f7dd0950">len</a>);</div>
<div class="line">        Serial.print(<span class="stringliteral">&quot;Data: &quot;</span>);</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code hl_variable" href="receive_8ino.html#a8bb3e1dd5fd30402c69fd8a9f7dd0950">len</a>; i++)</div>
<div class="line">        {</div>
<div class="line">            Serial.print(<a class="code hl_variable" href="receive_8ino.html#af5995a340a85e31e0916dd382c9b8eda">buf</a>[i], HEX);</div>
<div class="line">            Serial.print(<span class="stringliteral">&quot; &quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        Serial.println();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Process battery charge data if CAN ID matches our sender of interest</span></div>
<div class="line">        <span class="keywordflow">if</span> (canId == <a class="code hl_variable" href="RS485__CANHAT__Interfacing__Arduino_8ino.html#a09f97bd739f2e6ad7f715691adbf8dc1">BATTERY_CHARGE_CAN_ID</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">float</span> batteryCharge = <a class="code hl_variable" href="receive_8ino.html#af5995a340a85e31e0916dd382c9b8eda">buf</a>[0] + (<a class="code hl_variable" href="receive_8ino.html#af5995a340a85e31e0916dd382c9b8eda">buf</a>[1] &lt;&lt; 8); </div>
<div class="line">            batteryCharge /= <a class="code hl_variable" href="RS485__CANHAT__Interfacing__Arduino_8ino.html#abd34c2c9f838ac6dfba8d2f600f87e7f">BATTERY_SCALE</a>; </div>
<div class="line">            Serial.print(<span class="stringliteral">&quot;Battery Charge: &quot;</span>); Serial.print(batteryCharge); Serial.println(<span class="stringliteral">&quot; %&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="ttc" id="aRS485__CANHAT__Interfacing__Arduino_8ino_html_a09f97bd739f2e6ad7f715691adbf8dc1"><div class="ttname"><a href="RS485__CANHAT__Interfacing__Arduino_8ino.html#a09f97bd739f2e6ad7f715691adbf8dc1">BATTERY_CHARGE_CAN_ID</a></div><div class="ttdeci">const unsigned long BATTERY_CHARGE_CAN_ID</div><div class="ttdoc">I'll store the device ID of the battery info sender device into BATTERY_CHARGE_CAN_ID....</div><div class="ttdef"><b>Definition</b> RS485_CANHAT_Interfacing_Arduino.ino:30</div></div>
<div class="ttc" id="aRS485__CANHAT__Interfacing__Arduino_8ino_html_abd34c2c9f838ac6dfba8d2f600f87e7f"><div class="ttname"><a href="RS485__CANHAT__Interfacing__Arduino_8ino.html#abd34c2c9f838ac6dfba8d2f600f87e7f">BATTERY_SCALE</a></div><div class="ttdeci">const float BATTERY_SCALE</div><div class="ttdoc">We normally use percentage for knowing battery charge, so I'll use this Scale factor.</div><div class="ttdef"><b>Definition</b> RS485_CANHAT_Interfacing_Arduino.ino:31</div></div>
<div class="ttc" id="aclassMCP__CAN_html"><div class="ttname"><a href="classMCP__CAN.html">MCP_CAN</a></div><div class="ttdef"><b>Definition</b> mcp_can.h:29</div></div>
<div class="ttc" id="aclassMCP__CAN_html_a17db0c4bf45f6e0354c22ebb7ab218d6"><div class="ttname"><a href="classMCP__CAN.html#a17db0c4bf45f6e0354c22ebb7ab218d6">MCP_CAN::getCanId</a></div><div class="ttdeci">INT32U getCanId(void)</div><div class="ttdef"><b>Definition</b> mcp_can.cpp:786</div></div>
<div class="ttc" id="aclassMCP__CAN_html_a4a09b0c8d110b0e5a3900fadc7137632"><div class="ttname"><a href="classMCP__CAN.html#a4a09b0c8d110b0e5a3900fadc7137632">MCP_CAN::readMsgBuf</a></div><div class="ttdeci">INT8U readMsgBuf(INT8U *len, INT8U *buf)</div><div class="ttdef"><b>Definition</b> mcp_can.cpp:736</div></div>
<div class="ttc" id="aclassMCP__CAN_html_a744792a91a4604e22132f787dd2114b0"><div class="ttname"><a href="classMCP__CAN.html#a744792a91a4604e22132f787dd2114b0">MCP_CAN::begin</a></div><div class="ttdeci">INT8U begin(INT8U speedset)</div><div class="ttdef"><b>Definition</b> mcp_can.cpp:512</div></div>
<div class="ttc" id="amcp__can_8cpp_html_ae0f879ad16313dd3d0ae6074a887918f"><div class="ttname"><a href="mcp__can_8cpp.html#ae0f879ad16313dd3d0ae6074a887918f">CAN</a></div><div class="ttdeci">MCP_CAN CAN</div><div class="ttdef"><b>Definition</b> mcp_can.cpp:27</div></div>
<div class="ttc" id="amcp__can_8h_html"><div class="ttname"><a href="mcp__can_8h.html">mcp_can.h</a></div></div>
<div class="ttc" id="amcp__can__dfs_8h_html_a828ca6464d281c8b2a780169ac2c6318"><div class="ttname"><a href="mcp__can__dfs_8h.html#a828ca6464d281c8b2a780169ac2c6318">CAN_OK</a></div><div class="ttdeci">#define CAN_OK</div><div class="ttdef"><b>Definition</b> mcp_can_dfs.h:339</div></div>
<div class="ttc" id="amcp__can__dfs_8h_html_a838186bc9587b888bf99f730e69fc70d"><div class="ttname"><a href="mcp__can__dfs_8h.html#a838186bc9587b888bf99f730e69fc70d">CAN_500KBPS</a></div><div class="ttdeci">#define CAN_500KBPS</div><div class="ttdef"><b>Definition</b> mcp_can_dfs.h:337</div></div>
<div class="ttc" id="areceive_8ino_html_a25a5e2b8e715ec6077463e9effdcbd48"><div class="ttname"><a href="receive_8ino.html#a25a5e2b8e715ec6077463e9effdcbd48">Flag_Recv</a></div><div class="ttdeci">unsigned char Flag_Recv</div><div class="ttdef"><b>Definition</b> receive.ino:5</div></div>
<div class="ttc" id="areceive_8ino_html_a4fc01d736fe50cf5b977f755b675f11d"><div class="ttname"><a href="receive_8ino.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a></div><div class="ttdeci">void setup()</div><div class="ttdef"><b>Definition</b> receive.ino:10</div></div>
<div class="ttc" id="areceive_8ino_html_a8bb3e1dd5fd30402c69fd8a9f7dd0950"><div class="ttname"><a href="receive_8ino.html#a8bb3e1dd5fd30402c69fd8a9f7dd0950">len</a></div><div class="ttdeci">unsigned char len</div><div class="ttdef"><b>Definition</b> receive.ino:6</div></div>
<div class="ttc" id="areceive_8ino_html_ae4617499c61ae6c8bf1e9433b5436b8d"><div class="ttname"><a href="receive_8ino.html#ae4617499c61ae6c8bf1e9433b5436b8d">MCP2515_ISR</a></div><div class="ttdeci">void MCP2515_ISR()</div><div class="ttdef"><b>Definition</b> receive.ino:17</div></div>
<div class="ttc" id="areceive_8ino_html_af5995a340a85e31e0916dd382c9b8eda"><div class="ttname"><a href="receive_8ino.html#af5995a340a85e31e0916dd382c9b8eda">buf</a></div><div class="ttdeci">unsigned char buf[8]</div><div class="ttdef"><b>Definition</b> receive.ino:7</div></div>
<div class="ttc" id="areceive_8ino_html_afe461d27b9c48d5921c00d521181f12f"><div class="ttname"><a href="receive_8ino.html#afe461d27b9c48d5921c00d521181f12f">loop</a></div><div class="ttdeci">void loop()</div><div class="ttdef"><b>Definition</b> receive.ino:22</div></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
